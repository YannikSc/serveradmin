{% extends "base.html" %}
{% load serversearch %}
{% block title %}
    Servershell
{% endblock %}

{% block additional_styles %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/servershell.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/jquery-ui.min.css">
{% endblock %}

{% block content %}
    <!-- Servershell JS alerts -->
    <div id="js-alert" class="alert alert-dismissible fade show" role="alert" style="display: none;">
        <strong id="js-alert-message"></strong>
        <button type="button" class="close" onclick="$('#jjs-alert').toggle();" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- The Servershell Search -->
    <div class="form-group row input-controls">
        <label for="term" class="col-sm-1 col-form-label">Search:</label>
        <div class="col-sm-8">
            <form method="post" action="{% url 'servershell_results' %}" id="search_form">
                {% csrf_token %}
                <input class="form-control form-control-sm" type="text" id="term" data-servershell-property-bind="term" data-servershell-autocomplete-url="{% url 'servershell_autocomplete' %}" />
            </form>
            <!-- Advanced search options (hidden by default) -->
            <div class="collapse" id="search-options">
                <div class="card card-body">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="disable-autocompletion">
                        <label class="form-check-label" for="disable-autocompletion">
                            Disable Autocomplete
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-3">
            <img src="{{ STATIC_URL }}icons/question.svg" alt="How to search" data-toggle="modal" data-target="#modal-help-search"/>
            <button id="search-options-button" class="btn btn-sm btn-light" data-toggle="collapse" data-target="#search-options">Options</button>
        </div>
    </div>
    <div class="form-group row input-controls">
        <label for="command" class="col-sm-1 col-form-label">Command:</label>
        <div class="col-sm-8">
            <form method="post" id="command_form">
                <input class="form-control form-control-sm" type="text" size="60"  id="command" data-servershell-property-bind="command" />
            </form>
        </div>
        <div class="col-sm-3">
            <img src="{{ STATIC_URL }}icons/question.svg" alt="Show supported commands" data-toggle="modal" data-target="#modal-help-commands"/>
        </div>
    </div>
    <div class="form-group row input-controls">
        <label for="understood" class="col-sm-1 col-form-label">Understood:</label>
        <div class="col-sm-8">
            <input class="form-control form-control-sm" type="text" readonly="readonly" id="understood" data-servershell-property-bind="understood" />
        </div>
        <div class="col-sm-3">
            <a id="search_link" onclick="window.location.href=servershell.href;">
                <img src="{{ STATIC_URL }}icons/bookmark.svg" alt="Open current search in new tab"/>
            </a>
        </div>
    </div>

    <hr/>

    <!-- The Servershell Attributes Selection -->
    {# Do not move! CSS relative to top row #}
    <div id="attributes-row">
        <div id="attributes-container">
            <div class="accordion" id="accordion-attributes">
                <div class="card">
                    <div class="card-header">
                        <b>Attributes</b>
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#accordion-attributes-body"></button>
                    </div>
                    <div id="accordion-attributes-body" class="component collapse" data-parent="#accordion-attributes">
                        <div id="attributes" class="card-body">
                            {% regroup attributes by group as group_list %}
                            {% for group in group_list %}
                                <ul class="list-group list-group-flush">
                                    <b>{{ group.grouper }}</b>
                                    {% for attribute in group.list %}
                                        <li class="list-group-item">
                                            <input type="checkbox" id="{{ attribute.attribute_id }}" data-servershell-attribute="{{ attribute.attribute_id }}" />
                                            <label for="{{ attribute.attribute_id }}">{{ attribute.attribute_id }}</label>
                                            {% if attribute.hovertext %}
                                                <a class="attr-tooltip" href="{{ attribute.help_link }}" title="{{ attribute.hovertext }}">?</a>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The Servershell Results -->
    <div class="row">
        <div class="col-md-12">
            <div id="result_div">
                <div class="result_info">
                    <!-- Managed by Servershell Results -->
                </div>
                <table id="result_table" class="table table-bordered table-hover table-sm table-borderless table-striped table-responsive-lg table-flex">
                    <thead>
                        <tr>
                            <!-- Managed by Servershell Results -->
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="result_info">
                    <!-- Managed by Servershell Results -->
                </div>
            </div>
        </div>
    </div>

    <!-- The help for the modals in the Servershell -->
    {% include "servershell/modals/help_search.html" %}
    {% include "servershell/modals/help_command.html" %}
    <!-- The modals for editing and other commands -->
    {# We can probably make one general modal template out of these #}
    {% include "servershell/modals/export.html" %}
{% endblock %}

{% block additional_scripts %}
<script src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/servershell.js"></script>
<script src="{{ STATIC_URL }}js/servershell/attributes.js"></script>
<script src="{{ STATIC_URL }}js/servershell/search.js"></script>
<script src="{{ STATIC_URL }}js/servershell/result.js"></script>
<script src="{{ STATIC_URL }}js/servershell/command.js"></script>
<script src="{{ STATIC_URL }}js/servershell/choose_ip_address.js"></script>
<script src="{{ STATIC_URL }}js/servershell/autocomplete/search.js"></script>
<script src="{{ STATIC_URL }}js/servershell/autocomplete/command.js"></script>
<script>
    $(document).ready(function() {
        // Initialize servershell object properties with initial values
        // from backend. This allows us setting defaults from backend.
        servershell.term = "{{ term }}";
        servershell.command = "";
        servershell.understood = "";
        servershell.attributes = {% autoescape off %}{{ attributes|json }}{% endautoescape %}
        servershell.offset = {{ offset }};
        servershell.limit = {{ limit }};
        servershell.per_page = {{ per_page }};
        servershell.order_by = "{{ order_by }}";
        servershell.filters = {% autoescape off %}{{ filters|json }}{% endautoescape %}
        // Changing this property triggers a search ...
        servershell.shown_attributes = {% autoescape off %}{{ shown_attributes|json }}{% endautoescape %};
        servershell.to_commit = [];

        // We define the URLs once here so that we can render them with
        // template engine from the backend and can access them everywhere
        servershell.urls = {
            choose_ip_address: "{% url 'servershell_choose_ip_addr' %}",
            inspect: "{% url 'servershell_inspect' %}",
            edit: "{% url 'servershell_edit' %}",
            graphite: "{% url 'graphite_graph_table' %}",
            new: "{% url 'servershell_new' %}",
        }
    });
</script>
{% endblock %}
