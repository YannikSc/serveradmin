{% extends "base.html" %}

{% block title %}History for {{ server_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-6">
        <h3>
            History for {{ server_id }}
        </h3>
    </div>
</div>
<div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-6">
        {% for type, change in change_list %}
            <h5>Added server on {{ change.commit.change_on }} by {{ change.commit.user }}</h5>
        {% if type == 'add' %}
            <table class="table table-sm table-striped table-bordered table-borderless">
                <tbody>
                    {% for key, value in change.attributes.items %}
                    <tr>
                        <th>{{ key }}:</th>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <form method="post" action="{% url 'serverdb_restore_deleted' change.commit.id %}">
                {% csrf_token %}
                <input type="hidden" name="server_id" value="{{ change.server_id }}" />
                <input class="btn btn-sm btn-danger" type="submit" value="Restore this server" />
            </form>
        {% elif type == 'update' %}
            <h5>Changed attributes on {{ change.commit.change_on }} by {{ change.commit.user }}</h5>
        <table class="table table-sm table-striped table-bordered table-borderless">
            <thead>
                <tr>
                    <th>Attribute</th>
                    <th>Old/Removed</th>
                    <th>New/Added</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in change.updates.items %}
                {% if key != 'object_id' %}
                    <tr>
                        <td>{{ key }}</td>
                        {% if value.action == 'multi' %}
                        <td>
                            {% if value.remove %}
                                <ul>
                                {% for val in value.remove %}
                                    <li>{{ val }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <i>nothing removed</i>
                            {% endif %}
                        </td>
                        <td>
                            {% if value.add %}
                            <ul>
                            {% for val in value.add %}
                                <li>{{ val }}</li>
                            {% endfor %}
                            </ul>
                            {% else %}
                                <i>nothing added</i>
                            {% endif %}
                        </td>
                        {% else %}
                            <td>{{ value.old }}</td>
                            <td>{{ value.new }}</td>
                        {% endif %}
                    </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% elif type == 'delete' %}
            <h5>Deleted server on {{ change.commit.change_on }} by {{ change.commit.user }}</h5>
        {% endif %}
        {% endfor %}
        {% if commit_id %}
            <a href="{% url 'serverdb_history' %}?server_id={{ server_id }}">Show complete history</a>
        {% endif %}
    </div>
</div>

{% endblock %}
